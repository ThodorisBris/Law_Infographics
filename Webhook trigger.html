<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>ÎÎ¿Î¼Î¹ÎºÏŒ ÎšÎµÎ¯Î¼ÎµÎ½Î¿ ÏƒÎµ Î”Î¹Î¬Î³ÏÎ±Î¼Î¼Î±</title>
  <style>
    button {
      padding: 6px 12px;
      font-size: 14px;
      margin-right: 4px;
    }
  </style>
</head>
<body>

<h1>ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® ÎÎ¿Î¼Î¹ÎºÎ¿Ï ÎšÎµÎ¹Î¼Î­Î½Î¿Ï… ÏƒÎµ Î”Î¹Î¬Î³ÏÎ±Î¼Î¼Î±</h1>

<textarea id="legalText" rows="10" cols="80"
  placeholder="Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ ÎµÎ´Ï Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿ Ï„Î¿Ï… Î½ÏŒÎ¼Î¿Ï…..."></textarea>
<br><br>

<button id="generateBtn" onclick="sendText()">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î”Î¹Î±Î³ÏÎ¬Î¼Î¼Î±Ï„Î¿Ï‚</button>

<button id="downloadBtn" style="display:none;" onclick="downloadDiagram()">
  Î›Î®ÏˆÎ· Î”Î¹Î±Î³ÏÎ¬Î¼Î¼Î±Ï„Î¿Ï‚
</button>

<span id="spinner" style="display:none; margin-left:10px;">
  â³ Î Î±ÏÎ¬Î³ÎµÏ„Î±Î¹â€¦
</span>

<br><br>

<div id="zoomControls" style="display:none; margin-bottom:10px;">
  <button onclick="zoomOut()">âˆ’</button>
  <button onclick="resetZoom()">Reset</button>
  <button onclick="zoomIn()">+</button>

  <button id="orientationBtn" onclick="toggleOrientation()">
    Landscape
  </button>

  <span id="zoomLabel" style="margin-left:8px;">100%</span>
</div>

<img id="diagramImg"
     style="display:none;
            max-width:70%;
            margin-top:12px;
            border:1px solid #ddd;
            transform-origin: top left;" />

<script>
let diagramUrl = null;
let diagramBlob = null;
let zoom = 1.0;
let landscape = false;

function setLoading(isLoading) {
  document.getElementById("spinner").style.display = isLoading ? "inline" : "none";
  document.getElementById("generateBtn").disabled = isLoading;
}

function applyZoom() {
  const img = document.getElementById("diagramImg");
  img.style.transform = `scale(${zoom})`;
  document.getElementById("zoomLabel").textContent =
    Math.round(zoom * 100) + "%";
}

function zoomIn() {
  zoom = Math.min(3.0, zoom + 0.1);
  applyZoom();
}

function zoomOut() {
  zoom = Math.max(0.2, zoom - 0.1);
  applyZoom();
}

function resetZoom() {
  zoom = 1.0;
  applyZoom();
}

function applyOrientation() {
  const img = document.getElementById("diagramImg");
  img.style.maxWidth = landscape ? "95%" : "70%";
  document.getElementById("orientationBtn").textContent =
    landscape ? "Portrait" : "Landscape";
}

function toggleOrientation() {
  landscape = !landscape;
  applyOrientation();
}

async function sendText() {
  const text = document.getElementById("legalText").value;
  if (!text) {
    alert("Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ Ï„Î¿ ÎºÎµÎ¯Î¼ÎµÎ½Î¿!");
    return;
  }

  document.getElementById("downloadBtn").style.display = "none";
  setLoading(true);

  const url =
    "http://localhost:5678/webhook-test/Legal%20article%20to%20Diagram";

  let response;
  try {
    response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json; charset=UTF-8" },
      body: JSON.stringify({ text })
    });
  } catch (e) {
    alert(
      "âŒ Î”ÎµÎ½ Î¼Ï€Î¿ÏÏ Î½Î± ÏƒÏ…Î½Î´ÎµÎ¸Ï Î¼Îµ Ï„Î¿ n8n.\n\n" +
      "âœ” ÎˆÏ‡ÎµÎ¹Ï‚ Ï€Î±Ï„Î®ÏƒÎµÎ¹ Execute workflow;\n" +
      "âœ” Î•Î¯Î½Î±Î¹ Î±Î½Î¿Î¹Ï‡Ï„ÏŒ Ï„Î¿ n8n Desktop;\n\n" +
      e.message
    );
    setLoading(false);
    return;
  }

  if (!response.ok) {
    const err = await response.text();
    alert("âŒ Î£Ï†Î¬Î»Î¼Î± Î±Ï€ÏŒ n8n:\n\n" + err);
    setLoading(false);
    return;
  }

  const contentType = response.headers.get("Content-Type") || "";
  if (!contentType.startsWith("image/")) {
    const txt = await response.text();
    alert("âš ï¸ Î¤Î¿ n8n Î±Ï€Î¬Î½Ï„Î·ÏƒÎµ, Î±Î»Î»Î¬ ÏŒÏ‡Î¹ ÎµÎ¹ÎºÏŒÎ½Î±:\n\n" + txt);
    setLoading(false);
    return;
  }

  const blob = await response.blob();
  diagramBlob = blob;
  diagramUrl = URL.createObjectURL(blob);

  const img = document.getElementById("diagramImg");
  img.src = diagramUrl;
  img.style.display = "block";

  document.getElementById("downloadBtn").style.display = "inline-block";
  document.getElementById("zoomControls").style.display = "block";

  zoom = 1.0;
  landscape = false;
  applyZoom();
  applyOrientation();

  setLoading(false);
}

/* ğŸ”¥ Î£Î—ÎœÎ‘ÎÎ¤Î™ÎšÎŸ: ÎµÎ´Ï "ÏˆÎ®Î½Î¿Ï…Î¼Îµ" Î»ÎµÏ…ÎºÏŒ Ï†ÏŒÎ½Ï„Î¿ ÏƒÏ„Î¿ PNG */
async function downloadDiagram() {
  if (!diagramBlob) return;

  const tempUrl = URL.createObjectURL(diagramBlob);
  const img = new Image();

  img.onload = () => {
    const canvas = document.createElement("canvas");
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;

    const ctx = canvas.getContext("2d");

    // Î›ÎµÏ…ÎºÏŒ Ï†ÏŒÎ½Ï„Î¿
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Î•Î¹ÎºÏŒÎ½Î± Î±Ï€ÏŒ Ï€Î¬Î½Ï‰
    ctx.drawImage(img, 0, 0);

    canvas.toBlob((outBlob) => {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(outBlob);
      a.download = "diagram.png";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }, "image/png");

    URL.revokeObjectURL(tempUrl);
  };

  img.src = tempUrl;
}
</script>

</body>
</html>
